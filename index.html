<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interpretador de An√°lisis de Suelos</title>
  <style>
    :root{
      /* Paleta agricultura & zootecnia (verdes, tierra, cielo) */
      --bg:#0b1f14;           /* fondo bosque */
      --card:#0f2518;         /* tarjeta verde oscura */
      --muted:#9fb8a8;        /* texto secundario verdoso */
      --text:#e9f5ec;         /* texto principal claro */
      --accent:#86efac;       /* acento hoja */
      --ok:#2f855a;           /* verde agr√≥nomo */
      --warn:#d97706;         /* √°mbar cosecha */
      --bad:#b91c1c;          /* rojo arcilla */
      --mid:#3b82f6;          /* azul cielo (neutral) */
      --border:#17331f;       /* borde verde oscuro */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      background:linear-gradient(160deg,#07130a,var(--bg) 35%,#0a2012);
      color:var(--text)
    }
    header{
      position:sticky;
      top:0;
      background:rgba(11,31,20,.78);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
      z-index:10
    }
    .wrap{max-width:1200px;margin:auto;padding:16px}
    h1{
      margin:0;
      font-size:clamp(1.2rem,2.5vw,1.8rem);
      letter-spacing:.2px;
      display:flex;
      gap:.6rem;
      align-items:center
    }
    h1 .dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 14px var(--accent)
    }
    main{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:18px;
      padding:18px
    }
    @media (max-width:980px){main{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.00));
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px
    }
    .card h2{margin:.2rem 0 1rem;font-size:1.05rem;color:#fff}
    label{
      display:block;
      margin:.55rem 0 .25rem;
      color:var(--muted);
      font-size:.9rem
    }
    input[type=number],input[type=text],textarea,select{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      background:#0f1c14;
      color:#e5f3ea;
      border:1px solid #1e2b1b;
      outline:none;
      transition:border-color .2s, box-shadow .2s
    }
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{margin:0}
    .grid{display:grid;gap:10px}
    .g2{grid-template-columns:repeat(2,1fr)}
    .g3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:760px){.g2,.g3{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid #1e2b1b;
      background:#0f1c14;
      color:#e5f3ea;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer
    }
    .btn.primary{
      background:linear-gradient(135deg,#16a34a,#22c55e);
      border:none;
      color:#052e18;
      font-weight:600
    }
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.sm{padding:6px 10px;font-size:.8rem}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #233b2b;
      font-size:.85rem
    }
    .pill.ok{background:rgba(47,133,90,.12);border-color:rgba(47,133,90,.35)}
    .pill.warn{background:rgba(217,119,6,.12);border-color:rgba(217,119,6,.35)}
    .pill.bad{background:rgba(185,28,28,.12);border-color:rgba(185,28,28,.35)}
    .pill.mid{background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.35)}
    .dot-sm{width:8px;height:8px;border-radius:50%}
    .ok .dot-sm{background:var(--ok)}
    .warn .dot-sm{background:var(--warn)}
    .bad .dot-sm{background:var(--bad)}
    .mid .dot-sm{background:var(--mid)}
    .result{
      border-top:1px dashed #203524;
      padding-top:12px;
      margin-top:10px
    }
    .result h3{margin:.4rem 0 .3rem}
    .msg{font-size:.92rem;color:#d7e7dd}
    details{
      border:1px dashed #2c3e2e;
      padding:12px;
      border-radius:12px;
      background:rgba(10,26,17,.3)
    }
    details[open]{background:rgba(10,26,17,.45)}
    details summary{cursor:pointer;font-weight:600;margin:.2rem 0}
    footer{
      opacity:.9;
      text-align:center;
      padding:18px;
      color:#a9c5b5;
      font-size:.9rem
    }
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      background:#0f1c14;
      border:1px solid #1d3725;
      padding:2px 6px;
      border-radius:6px
    }
    .hr{
      height:1px;
      background:linear-gradient(90deg,transparent,#2a3f2d,transparent);
      margin:12px 0
    }
    .note{font-size:.85rem;color:#9fb8a8}
    .tag{
      border:1px solid #2a3f2d;
      background:#0f1c14;
      border-radius:8px;
      padding:4px 8px;
      font-size:.8rem;
      color:#cfe7da
    }
    .callout{
      border-left:3px solid var(--accent);
      padding:.6rem .8rem;
      background:rgba(134,239,172,.08);
      border-radius:10px
    }
    .t-pass{color:#86efac}
    .t-fail{color:#f4a9a9}
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace
    }
    .status{font-size:.85rem;opacity:.9}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--bad)}
    /* Estado de campos (colores acordes a agro) */
    input.is-ok, select.is-ok, textarea.is-ok{
      border-color:rgba(47,133,90,.85);
      box-shadow:0 0 0 3px rgba(47,133,90,.18) inset
    }
    input.is-err, select.is-err, textarea.is-err{
      border-color:rgba(185,28,28,.85);
      box-shadow:0 0 0 3px rgba(185,28,28,.15) inset
    }
    .input-wrap{display:flex;gap:8px;align-items:center}
    /* Resumen y grupos */
    .summary-card{
      border:1px solid #25633a;
      border-radius:12px;
      padding:10px 12px;
      background:rgba(22,163,74,.13);
      margin-bottom:10px
    }
    .summary-card h3{margin:0 0 4px}
    .group-block{margin-top:8px}
    .group-title{
      margin:0.6rem 0 0.2rem;
      font-size:.98rem;
      color:#e9f5ec
    }
    #resultFilters .btn.sm{padding:4px 10px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1><span class="dot"></span> ** SOY TU ASISTENTE AGR√çCOLA ** Interpretador de An√°lisis de Suelos <span class="tag">Beta</span></h1>
    </div>
  </header>
  <div class="wrap">
    <div class="callout" style="margin:14px 0">
      Esta app te ayuda a <strong>interpretar</strong> resultados t√≠picos de laboratorio (rangos generales). Los umbrales pueden variar por cultivo, extracci√≥n y regi√≥n. √ösala como <em>gu√≠a t√©cnica</em> y valida con tu agr√≥nomo.
    </div>
  </div>
  <main class="wrap">
    <!-- FORMULARIO -->
    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title">1) Ingresar resultados del laboratorio</h2>
      <div class="grid g3">
        <div>
          <label for="ph" title="pH en pasta saturada o mezcla 1:1. Rangos: &lt;5.5 muy √°cido, 6‚Äì6.5 √≥ptimo general, &gt;7.8 alcalino.">
            pH (suelo 1:1)
          </label>
          <input type="number" id="ph" step="0.01" min="0" placeholder="ej. 5.8">
        </div>
        <div>
          <label for="ec" title="Conductividad el√©ctrica de extracto de saturaci√≥n, en dS/m. &lt;2 no salino; &gt;4 ya afecta muchos cultivos.">
            Conductividad el√©ctrica (dS/m)
          </label>
          <input type="number" id="ec" step="0.01" min="0" placeholder="ej. 1.2">
        </div>
        <div>
          <label for="om" title="Porcentaje de materia org√°nica. &lt;2 baja, 2‚Äì4 media, &gt;4 alta (referencia general).">
            Materia org√°nica (%)
          </label>
          <input type="number" id="om" step="0.1" min="0" placeholder="ej. 2.5">
        </div>
      </div>

      <div class="grid g3">
        <div>
          <label for="n" title="Nitr√≥geno n√≠trico disponible (mg/kg). Muy variable en el tiempo, usar solo como indicador de corto plazo.">
            Nitr√≥geno (N) disponible (mg/kg, nitrato)
          </label>
          <input type="number" id="n" step="0.1" min="0" placeholder="ej. 20">
        </div>
        <div>
          <label for="p" title="F√≥sforo disponible (Bray/Olsen, mg/kg). &lt;10 muy bajo; 10‚Äì20 bajo; 20‚Äì40 medio; &gt;40 alto.">
            F√≥sforo (P) disponible (mg/kg)
          </label>
          <input type="number" id="p" step="0.1" min="0" placeholder="ej. 18">
        </div>
        <div>
          <label for="k" title="Potasio intercambiable (mg/kg). &lt;80 bajo; 80‚Äì150 medio; &gt;150 alto (referencia general).">
            Potasio (K) intercambiable (mg/kg)
          </label>
          <input type="number" id="k" step="1" min="0" placeholder="ej. 120">
        </div>
      </div>

      <div class="grid g3">
        <div>
          <label for="s" title="Azufre como sulfatos disponibles (mg/kg). &lt;5 bajo; 5‚Äì10 marginal; &gt;10 adecuado.">
            Azufre (S) sulfatos (mg/kg)
          </label>
          <input type="number" id="s" step="0.1" min="0" placeholder="ej. 8">
        </div>
        <div>
          <label for="cec" title="Capacidad de intercambio cati√≥nico (cmol+/kg). Indica la capacidad de retener cationes y fertilizantes.">
            CEC (cmol<sup>+</sup>/kg)
          </label>
          <input type="number" id="cec" step="0.1" min="0" placeholder="ej. 12">
        </div>
        <div>
          <label for="texture" title="Textura dominante del horizonte muestreado. Afecta dosis, fraccionamiento y riesgo de p√©rdidas.">
            Textura (opcional)
          </label>
          <select id="texture">
            <option value="">Seleccionar‚Ä¶</option>
            <option>Arenosa</option>
            <option>Franca</option>
            <option>Franco-arcillosa</option>
            <option>Arcillosa</option>
          </select>
        </div>
      </div>

      <div class="grid g3">
        <div>
          <label for="ca" title="Calcio intercambiable (cmol+/kg). Relaci√≥n con Mg y Na importante para estructura.">
            Calcio (Ca) (cmol<sup>+</sup>/kg)
          </label>
          <input type="number" id="ca" step="0.1" min="0" placeholder="ej. 6">
        </div>
        <div>
          <label for="mg" title="Magnesio intercambiable (cmol+/kg). Ver relaci√≥n Ca:Mg y posibles desbalances.">
            Magnesio (Mg) (cmol<sup>+</sup>/kg)
          </label>
          <input type="number" id="mg" step="0.1" min="0" placeholder="ej. 2">
        </div>
        <div>
          <label for="na" title="Sodio intercambiable (cmol+/kg). Importante para riesgo de sodicidad y estructura.">
            Sodio (Na) (cmol<sup>+</sup>/kg) (opcional)
          </label>
          <input type="number" id="na" step="0.1" min="0" placeholder="ej. 0.5">
        </div>
      </div>

      <div class="grid g3">
        <div>
          <label for="fe" title="Hierro disponible por DTPA (mg/kg). Puede limitar en suelos calizos o muy alcalinos.">
            Hierro (Fe) DTPA (mg/kg)
          </label>
          <input type="number" id="fe" step="0.1" min="0" placeholder="ej. 6">
        </div>
        <div>
          <label for="zn" title="Zinc DTPA (mg/kg). Clave en ma√≠z, arroz y varios cultivos extensivos.">
            Zinc (Zn) DTPA (mg/kg)
          </label>
          <input type="number" id="zn" step="0.01" min="0" placeholder="ej. 0.7">
        </div>
        <div>
          <label for="mn" title="Manganeso DTPA (mg/kg). Deficiencias m√°s frecuentes en pH altos.">
            Manganeso (Mn) DTPA (mg/kg)
          </label>
          <input type="number" id="mn" step="0.1" min="0" placeholder="ej. 12">
        </div>
      </div>

      <div class="grid g3">
        <div>
          <label for="cu" title="Cobre DTPA (mg/kg). Importante en suelos muy org√°nicos o arenosos.">
            Cobre (Cu) DTPA (mg/kg)
          </label>
          <input type="number" id="cu" step="0.01" min="0" placeholder="ej. 0.3">
        </div>
        <div>
          <label for="b" title="Boro disponible (mg/kg). Margen estrecho entre deficiencia y toxicidad.">
            Boro (B) caliente-agua (mg/kg)
          </label>
          <input type="number" id="b" step="0.01" min="0" placeholder="ej. 0.7">
        </div>
        <div>
          <label for="crop" title="Nombre del cultivo o pastura objetivo. Ayuda a contextualizar las recomendaciones.">
            Cultivo (opcional, texto libre)
          </label>
          <input type="text" id="crop" placeholder="ej. Ma√≠z, caf√©, pastos‚Ä¶">
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnRun" type="button">Interpretar</button>
        <button class="btn" id="btnDemo" type="button">Cargar ejemplo</button>
        <button class="btn ghost" id="btnClear" type="button">Limpiar</button>
        <button class="btn" id="btnSave" type="button" title="Guardar en este navegador">Guardar</button>
        <button class="btn" id="btnLoad" type="button" title="Cargar guardado">Cargar</button>
        <button class="btn" id="btnPrint" type="button" title="Imprimir/Guardar PDF">Exportar PDF</button>
        <span id="saveStatus" class="status"></span>
        <span id="pdfStatus" class="status"></span>
      </div>
      <p class="note">
        Unidades esperadas: P, K, S y micronutrientes en mg/kg (ppm); CEC, Ca, Mg y Na en cmol<sup>+</sup>/kg; pH en unidad;
        CE en dS/m; MO en %.
      </p>

      <div class="hr"></div>

      <details>
        <summary>üìå Recomendaciones para tomar <strong>muestras de suelo</strong> (mostrar/ocultar)</summary>
        <ul>
          <li>Definir lotes homog√©neos por pendiente, manejo y textura. Evitar mezclar √°reas con historial distinto.</li>
          <li>Tomar 15‚Äì20 submuestras por lote en zigzag, a la <strong>profundidad</strong> de inter√©s (0‚Äì20 cm para la mayor√≠a de cultivos; 20‚Äì40 cm si se requiere perfil).</li>
          <li>Usar barreno, pala o calador limpio. Evitar contaminaci√≥n con fertilizantes, cal, √≥xidos o sudor.</li>
          <li>Retirar hojarasca superficial antes de muestrear. Colocar las submuestras en un balde <em>limpio</em> y mezclar.</li>
          <li>Componer una muestra de ~0,5‚Äì1 kg, <strong>rotular</strong> (lote, fecha, cultivo) y secar a la sombra si no se env√≠a de inmediato.</li>
          <li>Si hay encharcamientos, caminos, bebederos o bordes, evitarlos; muestrear a &gt;5 m de cercas y canales.</li>
          <li>Repetir el muestreo cada 6‚Äì12 meses o antes de la siembra/establecimiento.</li>
        </ul>
        <p class="note">Para diagn√≥sticos de salinidad/sodicidad, incluir submuestras profundas y solicitar RAS/SAR, PSI y yeso si aplica.</p>
      </details>
    </section>

    <!-- RESULTADOS -->
    <section class="card" aria-labelledby="res-title">
      <h2 id="res-title">2) Resultados e interpretaci√≥n</h2>

      <div class="row" id="resultFilters">
        <span class="note">Filtro de vista:</span>
        <button class="btn sm" type="button" id="fltAll">Ver todo</button>
        <button class="btn sm" type="button" id="fltIssues">Solo bajos/cr√≠ticos</button>
      </div>

      <div id="results">
        <p class="note">Ingresa datos y presiona <strong>Interpretar</strong>.</p>
      </div>

      <div class="hr"></div>
      <h2>Gr√°ficos en tiempo real</h2>
      <div id="charts"><canvas id="nutrientChart" style="width:100%; max-height:300px;"></canvas></div>
      <div class="hr"></div>
      <h2 style="margin-top:0.6rem">3) IA ‚Äì Ampliar informaci√≥n</h2>
      <label for="apiKey">API Key de aistudio.google.com (Gemini)</label>
      <div class="input-wrap">
        <input id="apiKey" type="password" placeholder="Pega tu API Key (se usa solo localmente)">
        <button class="btn sm" id="btnToggleKey" type="button" aria-pressed="false" aria-label="Mostrar API Key">Mostrar</button>
      </div>
      <div class="row" id="keyActions">
        <button class="btn" id="btnSaveKey" type="button" title="Guardar en este navegador">Guardar API Key</button>
        <button class="btn" id="btnTestKey" type="button" title="Probar la API Key contra Google AI Studio">Probar API Key</button>
        <span class="note" id="keyStatus"></span>
      </div>
      <label for="modelSel">Modelo (AI Studio)</label>
      <select id="modelSel">
        <option value="gemini-1.5-flash-latest">gemini-1.5-flash-latest</option>
        <option value="gemini-1.5-flash">gemini-1.5-flash</option>
        <option value="gemini-1.5-pro-latest">gemini-1.5-pro-latest</option>
      </select>
      <label for="aiQ">Pregunta o tema a ampliar</label>
      <textarea id="aiQ" rows="4" placeholder="Ej.: Recomendaciones de fertilizaci√≥n para ma√≠z con P bajo y pH 5.4 en suelo franco."></textarea>
      <div style="margin:.2rem 0 .6rem">
        <label><input type="checkbox" id="ctx"> Incluir un resumen de los resultados como contexto</label><br>
        <label><input type="checkbox" id="edu"> Explicar muy bien los datos</label>
      </div>
      <div class="row">
        <button class="btn primary" id="btnAskAI" type="button">Consultar IA</button>
        <span class="note">La app intentar√° <span class="kbd">v1</span> y si corresponde <span class="kbd">v1beta</span> autom√°ticamente.</span>
      </div>
      <div id="aiOut" class="result" style="display:none"></div>
    </section>
  </main>

  <div class="wrap">
    <section class="card">
      <h2>Notas t√©cnicas y l√≠mites de referencia</h2>
      <ul class="note">
        <li><strong>pH (suelo):</strong> &lt;5.5 muy √°cido; 5.5‚Äì6.0 √°cido; 6.0‚Äì6.5 ligeramente √°cido; 6.5‚Äì7.3 neutro; 7.4‚Äì7.8 ligeramente alcalino; &gt;7.8 alcalino.</li>
        <li><strong>CE (dS/m):</strong> &lt;2 no salino; 2‚Äì4 ligero; 4‚Äì8 moderado; &gt;8 severo.</li>
        <li><strong>MO (%):</strong> &lt;2 baja; 2‚Äì4 media; &gt;4 alta (rangos generales, suelos tropicales pueden ser m√°s bajos).</li>
        <li><strong>P (mg/kg):</strong> &lt;10 muy bajo; 10‚Äì20 bajo; 20‚Äì40 medio; &gt;40 alto (m√©todo Bray/Olsen t√≠pico).</li>
        <li><strong>K (mg/kg):</strong> &lt;80 bajo; 80‚Äì150 medio; &gt;150 alto (extr. acetato amonio, referencia general).</li>
        <li><strong>N (mg/kg, NO‚ÇÉ‚Åª-N):</strong> &lt;10 muy bajo; 10‚Äì25 bajo; 25‚Äì50 medio; &gt;50 alto (muy variable estacionalmente).</li>
        <li><strong>S (mg/kg):</strong> &lt;5 bajo; 5‚Äì10 marginal; &gt;10 adecuado.</li>
        <li><strong>CEC (cmol<sup>+</sup>/kg):</strong> &lt;6 baja; 6‚Äì12 media; 12‚Äì25 alta; &gt;25 muy alta.</li>
        <li><strong>Fe (mg/kg DTPA):</strong> &lt;4 bajo; 4‚Äì7 marginal; &gt;7 adecuado.</li>
        <li><strong>Zn (mg/kg DTPA):</strong> &lt;0.5 bajo; 0.5‚Äì1 marginal; &gt;1 adecuado.</li>
        <li><strong>Mn (mg/kg DTPA):</strong> &lt;5 bajo; 5‚Äì10 marginal; &gt;10 adecuado.</li>
        <li><strong>Cu (mg/kg DTPA):</strong> &lt;0.2 bajo; 0.2‚Äì0.5 marginal; &gt;0.5 adecuado.</li>
        <li><strong>B (mg/kg):</strong> &lt;0.5 bajo; 0.5‚Äì1.5 adecuado; &gt;2 riesgo de toxicidad (cultivos sensibles).</li>
      </ul>
      <p class="note">Ajusta criterios seg√∫n cultivo, m√©todo anal√≠tico y textura. Para recomendaciones de dosis, combina con metas de rendimiento y an√°lisis foliar.</p>
    </section>
  </div>

  <div class="wrap">
    <section class="card" aria-labelledby="qa-title">
      <h2 id="qa-title">Pruebas autom√°ticas (QA)</h2>
      <p class="note">Estas pruebas ayudan a detectar errores comunes en el DOM y en la l√≥gica.</p>
      <div class="row">
        <button class="btn" id="btnRunTests" type="button">Ejecutar pruebas</button>
        <span class="note" id="testStatus"></span>
      </div>
      <pre id="testLog" class="mono" style="white-space:pre-wrap;background:#0f1c14;border:1px solid #1d3725;border-radius:10px;padding:10px;max-height:220px;overflow:auto"></pre>
    </section>
  </div>

  <footer>
    Yesenia Mu√±oz Ruiz **UNAD 2025** Hecho con ‚ù§ para productores y estudiantes. ‚Äî Uso educativo. Validar en campo.
  </footer>

  <script>
    const el = (id)=>document.getElementById(id);

    const levels = {
      ok:{cls:'ok', label:'Adecuado ‚úÖ'},
      mid:{cls:'mid', label:'Medio üü¶'},
      warn:{cls:'warn', label:'Bajo/Marginal ‚ö†Ô∏è'},
      bad:{cls:'bad', label:'Cr√≠tico üö®'}
    };

    function pill(level, text){
      return `<span class="pill ${level.cls}"><span class="dot-sm"></span>${text}</span>`;
    }

    function parseNum(v){
      const n = parseFloat(String(v).replace(",",".")); 
      return Number.isFinite(n) ? n : null;
    }

    // --- Categorizaciones generales ---
    function catPH(v){
      if(v==null) return null;
      if(v < 5.5) return {lvl:levels.bad, msg:'Muy √°cido: posible toxicidad de Al/Mn y baja disponibilidad de P, Ca, Mg.'};
      if(v < 6.0) return {lvl:levels.warn, msg:'√Åcido: mejorar con encalado si el cultivo lo requiere.'};
      if(v < 6.5) return {lvl:levels.mid, msg:'Ligeramente √°cido: bueno para la mayor√≠a; monitorear P.'};
      if(v <= 7.3) return {lvl:levels.ok, msg:'Neutral: m√°xima disponibilidad general de nutrientes.'};
      if(v <= 7.8) return {lvl:levels.mid, msg:'Ligeramente alcalino: vigilar P, Zn, Fe.'};
      return {lvl:levels.warn, msg:'Alcalino: riesgo de deficiencias de micronutrientes (Fe, Zn, Mn).'};
    }
    function catEC(v){
      if(v==null) return null;
      if(v < 2) return {lvl:levels.ok, msg:'No salino.'};
      if(v < 4) return {lvl:levels.mid, msg:'Salinidad ligera: monitorear riego y drenaje.'};
      if(v < 8) return {lvl:levels.warn, msg:'Salinidad moderada: considerar lavado y manejo de sales.'};
      return {lvl:levels.bad, msg:'Salinidad severa: requiere intervenci√≥n (drenaje, lavado, yeso si hay sodio).'};
    }
    function catOM(v){
      if(v==null) return null;
      if(v < 2) return {lvl:levels.warn, msg:'MO baja: incorporar residuos/abonos org√°nicos y cultivos de cobertura.'};
      if(v <= 4) return {lvl:levels.mid, msg:'MO media: mantener aportes y evitar labranza intensiva.'};
      return {lvl:levels.ok, msg:'MO alta: buena retenci√≥n y actividad biol√≥gica.'};
    }
    function catP(v){
      if(v==null) return null;
      if(v < 10) return {lvl:levels.bad, msg:'P muy bajo: aplicar fuentes fosfatadas, posible encalado en suelos √°cidos.'};
      if(v < 20) return {lvl:levels.warn, msg:'P bajo: fertilizar seg√∫n meta de rendimiento.'};
      if(v <= 40) return {lvl:levels.mid, msg:'P medio: mantenimiento.'};
      return {lvl:levels.ok, msg:'P alto: ajustar a mantenimiento; evitar excesos.'};
    }
    function catK(v){
      if(v==null) return null;
      if(v < 80) return {lvl:levels.warn, msg:'K bajo: requerir√° fertilizaci√≥n pot√°sica.'};
      if(v <= 150) return {lvl:levels.mid, msg:'K medio: dosis de mantenimiento.'};
      return {lvl:levels.ok, msg:'K alto: mantener, evitar lixiviaci√≥n en suelos arenosos.'};
    }
    function catN(v){
      if(v==null) return null;
      if(v < 10) return {lvl:levels.bad, msg:'N muy bajo: planificar programa de N fraccionado.'};
      if(v < 25) return {lvl:levels.warn, msg:'N bajo: aplicar y fraccionar seg√∫n cultivo.'};
      if(v <= 50) return {lvl:levels.mid, msg:'N medio: mantenimiento; considerar mineralizaci√≥n de MO.'};
      return {lvl:levels.ok, msg:'N alto: riesgo de p√©rdidas, ajustar dosis.'};
    }
    function catS(v){
      if(v==null) return null;
      if(v < 5) return {lvl:levels.warn, msg:'S bajo: considerar yeso/fuentes sulfatadas (ej. sulfato de amonio/potasio).'};
      if(v <= 10) return {lvl:levels.mid, msg:'S marginal: monitorear; aportes org√°nicos ayudan.'};
      return {lvl:levels.ok, msg:'S adecuado.'};
    }
    function catCEC(v){
      if(v==null) return null;
      if(v < 6) return {lvl:levels.warn, msg:'CEC baja: poca reserva; fraccionar fertilizaci√≥n y usar MO.'};
      if(v <= 12) return {lvl:levels.mid, msg:'CEC media: manejo est√°ndar, evitar p√©rdidas.'};
      if(v <= 25) return {lvl:levels.ok, msg:'CEC alta: buena retenci√≥n.'};
      return {lvl:levels.ok, msg:'CEC muy alta: gran capacidad de intercambio; vigilar fijaci√≥n de P en arcillas reactivas.'};
    }
    function catFe(v){
      if(v==null) return null;
      if(v < 4) return {lvl:levels.warn, msg:'Fe bajo: clorosis en pH alto; quelatos si es necesario.'};
      if(v <= 7) return {lvl:levels.mid, msg:'Fe marginal: monitoreo visual y foliar.'};
      return {lvl:levels.ok, msg:'Fe adecuado.'};
    }
    function catZn(v){
      if(v==null) return null;
      if(v < 0.5) return {lvl:levels.warn, msg:'Zn bajo: aplicar granular/foliar, sensible en ma√≠z/arroces.'};
      if(v <= 1.0) return {lvl:levels.mid, msg:'Zn marginal: monitorear.'};
      return {lvl:levels.ok, msg:'Zn adecuado.'};
    }
    function catMn(v){
      if(v==null) return null;
      if(v < 5) return {lvl:levels.warn, msg:'Mn bajo: m√°s probable en pH alto; aplicaciones foliares si hay s√≠ntomas.'};
      if(v <= 10) return {lvl:levels.mid, msg:'Mn marginal: vigilar pH.'};
      return {lvl:levels.ok, msg:'Mn adecuado.'};
    }
    function catCu(v){
      if(v==null) return null;
      if(v < 0.2) return {lvl:levels.warn, msg:'Cu bajo: raro pero importante en org√°nicos/arenosos; foliar si s√≠ntomas.'};
      if(v <= 0.5) return {lvl:levels.mid, msg:'Cu marginal: monitorear.'};
      return {lvl:levels.ok, msg:'Cu adecuado.'};
    }
    function catB(v){
      if(v==null) return null;
      if(v < 0.5) return {lvl:levels.warn, msg:'B bajo: cuidado con sobredosificaci√≥n; aplicar con precisi√≥n.'};
      if(v <= 1.5) return {lvl:levels.ok, msg:'B adecuado (atenci√≥n a cultivos sensibles).'};
      if(v <= 2.0) return {lvl:levels.mid, msg:'B alto: riesgo en sensibles; evitar acumulaci√≥n.'};
      return {lvl:levels.bad, msg:'B muy alto: riesgo de toxicidad; evitar aportes.'};
    }

    function collectFormData(){
      const get = id => (el(id) ? el(id).value : '');
      return {
        ph:get('ph'), ec:get('ec'), om:get('om'), n:get('n'), p:get('p'), k:get('k'), s:get('s'), cec:get('cec'), texture:get('texture'),
        ca:get('ca'), mg:get('mg'), na:get('na'), fe:get('fe'), zn:get('zn'), mn:get('mn'), cu:get('cu'), b:get('b'), crop:get('crop')
      };
    }

    function buildInterpretation(){
      const safeVal = id => (el(id) ? el(id).value : '');
      const vals = {
        ph: parseNum(safeVal('ph')),
        ec: parseNum(safeVal('ec')),
        om: parseNum(safeVal('om')),
        n: parseNum(safeVal('n')),
        p: parseNum(safeVal('p')),
        k: parseNum(safeVal('k')),
        s: parseNum(safeVal('s')),
        cec: parseNum(safeVal('cec')),
        texture: safeVal('texture') || null,
        ca: parseNum(safeVal('ca')),
        mg: parseNum(safeVal('mg')),
        na: parseNum(safeVal('na')),
        fe: parseNum(safeVal('fe')),
        zn: parseNum(safeVal('zn')),
        mn: parseNum(safeVal('mn')),
        cu: parseNum(safeVal('cu')),
        b: parseNum(safeVal('b')),
        crop: safeVal('crop') || null
      };

      const groups = { general:[], macro:[], micro:[] };
      const issues = [];

      function addBlock(groupKey, title, cat, val, unit){
        if(!cat) return;
        const px = pill(cat.lvl, cat.lvl.label);
        const vtxt = (val!=null? `${val} ${unit||''}` : 's/d');
        const lvlClass = cat.lvl.cls;
        const html = `
          <div class="result" data-level="${lvlClass}" data-kind="param">
            <h3>${title} ${px}</h3>
            <div class="msg">Valor: <span class="kbd">${vtxt}</span></div>
            <div class="msg">${cat.msg}</div>
          </div>
        `;
        groups[groupKey].push(html);
        if(lvlClass === 'bad' || lvlClass === 'warn'){
          issues.push({ title, lvl:lvlClass, msg:cat.msg });
        }
      }

      // Bloques con iconos por tipo
      addBlock('general','‚öóÔ∏è pH', catPH(vals.ph), vals.ph, 'u');
      addBlock('general','üíß Conductividad el√©ctrica (CE)', catEC(vals.ec), vals.ec, 'dS/m');
      addBlock('general','üçÇ Materia org√°nica (MO)', catOM(vals.om), vals.om, '%');
      addBlock('general','‚öóÔ∏è CEC', catCEC(vals.cec), vals.cec, 'cmol‚Å∫/kg');

      addBlock('macro','üåæ Nitr√≥geno disponible (N, NO‚ÇÉ‚Åª-N)', catN(vals.n), vals.n, 'mg/kg');
      addBlock('macro','üåæ F√≥sforo disponible (P)', catP(vals.p), vals.p, 'mg/kg');
      addBlock('macro','üåæ Potasio intercambiable (K)', catK(vals.k), vals.k, 'mg/kg');
      addBlock('macro','üåæ Azufre (S) sulfatos', catS(vals.s), vals.s, 'mg/kg');

      addBlock('micro','üî¨ Hierro (Fe) DTPA', catFe(vals.fe), vals.fe, 'mg/kg');
      addBlock('micro','üî¨ Zinc (Zn) DTPA', catZn(vals.zn), vals.zn, 'mg/kg');
      addBlock('micro','üî¨ Manganeso (Mn) DTPA', catMn(vals.mn), vals.mn, 'mg/kg');
      addBlock('micro','üî¨ Cobre (Cu) DTPA', catCu(vals.cu), vals.cu, 'mg/kg');
      addBlock('micro','üî¨ Boro (B)', catB(vals.b), vals.b, 'mg/kg');

      // Relaciones y diagn√≥sticos especiales
      const extra = [];
      if(vals.ca!=null && vals.mg!=null && vals.mg>0){
        const ratio = (vals.ca/vals.mg).toFixed(2);
        extra.push(`Relaci√≥n Ca:Mg = <span class="kbd">${ratio}</span> (√≥ptimo t√≠pico 3:1 a 7:1).`);
      }
      if(vals.na!=null && vals.ec!=null && vals.na>1 && vals.ec>=2){
        extra.push('Sodio y salinidad presentes: evaluar RAS/SAR y posible uso de yeso + lavado.');
      }
      if(vals.texture){
        extra.push(`Textura declarada: <span class="kbd">${vals.texture}</span>. Adapta dosis (arenosas: fraccionar m√°s; arcillosas: cuidado fijaci√≥n P).`);
      }
      if(vals.crop){
        extra.push(`Cultivo de inter√©s: <span class="kbd">${vals.crop}</span>. Ajusta con curvas espec√≠ficas y metas de rendimiento.`);
      }

      // Reglas para sugerencias generales
      const sug = [];
      if(vals.ph!=null && vals.ph<5.8) sug.push('Considerar <strong>encalado</strong> (CaCO‚ÇÉ/Cal dolom√≠tica) seg√∫n acidez y textura.');
      if(vals.ph!=null && vals.ph>7.8) sug.push('Evitar encalar; preferir <strong>fuentes acidificantes</strong> localizadas y quelatos de micronutrientes.');
      if(vals.p!=null && vals.p<20) sug.push('Aplicar <strong>P</strong> a la siembra, localizado; combinar con MO para reducir fijaci√≥n.');
      if(vals.k!=null && vals.k<80) sug.push('Planificar <strong>K</strong> (ej. KCl/K‚ÇÇSO‚ÇÑ) fraccionado en suelos de CEC baja.');
      if(vals.n!=null && vals.n<25) sug.push('Programar <strong>N</strong> fraccionado (emergencia/crecimiento/floraci√≥n) y considerar inhibidores.');
      if(vals.om!=null && vals.om<2) sug.push('Incrementar <strong>MO</strong>: abonos verdes, coberturas, compost y menos labranza.');
      if(vals.ec!=null && vals.ec>=4) sug.push('Manejar <strong>salinidad</strong>: drenaje, lavado con buena calidad de agua; monitoreo CE de riego.');
      if(vals.b!=null && vals.b>2) sug.push('Riesgo de <strong>toxicidad por B</strong>: evitar aportes y mejorar lixiviaci√≥n si el cultivo es sensible.');

      const out = [];
      const hasAnyGroup = groups.general.length || groups.macro.length || groups.micro.length;

      // Sem√°foro global y resumen
      if(hasAnyGroup){
        const badCount = issues.filter(i=>i.lvl==='bad').length;
        const warnCount = issues.filter(i=>i.lvl==='warn').length;

        let riskLabel = 'üü© Riesgo bajo';
        let riskDetail = 'La mayor√≠a de par√°metros est√°n en rangos adecuados o medios.';
        if(badCount>0){
          riskLabel = 'üü• Riesgo alto';
          riskDetail = `${badCount} par√°metro(s) en nivel cr√≠tico y ${warnCount} en bajo/marginal.`;
        } else if(warnCount>0){
          riskLabel = 'üüß Riesgo medio';
          riskDetail = `${warnCount} par√°metro(s) en nivel bajo/marginal.`;
        }

        let topLim = 'Ninguno cr√≠tico o bajo.';
        if(issues.length){
          const sev = {bad:2, warn:1};
          const sorted = [...issues].sort((a,b)=> sev[b.lvl]-sev[a.lvl]);
          const names = [...new Set(sorted.map(i=>i.title))].slice(0,3);
          topLim = names.join(', ');
        }

        out.push(`
          <div class="summary-card">
            <h3>Resumen r√°pido üå±</h3>
            <div class="msg">
              Estado general del suelo: <strong>${riskLabel}</strong><br>
              ${riskDetail}<br>
              Limitantes principales: <strong>${topLim}</strong>
            </div>
          </div>
        `);
      }

      // Grupos
      if(groups.general.length){
        out.push(`
          <div class="group-block">
            <h3 class="group-title">Propiedades generales ‚öóÔ∏è</h3>
            ${groups.general.join('')}
          </div>
        `);
      }
      if(groups.macro.length){
        out.push(`
          <div class="group-block">
            <h3 class="group-title">Macronutrientes üåæ</h3>
            ${groups.macro.join('')}
          </div>
        `);
      }
      if(groups.micro.length){
        out.push(`
          <div class="group-block">
            <h3 class="group-title">Micronutrientes üî¨</h3>
            ${groups.micro.join('')}
          </div>
        `);
      }

      if(extra.length){
        out.push(`
          <div class="result" data-kind="extra">
            <h3>Observaciones üìù</h3>
            <div class="msg">‚Ä¢ ${extra.join('<br>‚Ä¢ ')}</div>
          </div>
        `);
      }
      if(sug.length){
        out.push(`
          <div class="result" data-kind="extra">
            <h3>Recomendaciones generales üå±</h3>
            <div class="msg">‚Ä¢ ${sug.join('<br>‚Ä¢ ')}</div>
          </div>
        `);
      }

      if(!hasAnyGroup && !extra.length){
        el('results').innerHTML = '<p class="note">Ingresa datos y presiona <strong>Interpretar</strong>.</p>';
      } else {
        el('results').innerHTML = out.join('');
      }

      drawNutrientChart(vals);
      applyFilter('all'); // reset filtro despu√©s de cada interpretaci√≥n

      return {vals, text: el('results').innerText.trim()};
    }

    function drawNutrientChart(vals) {
      const cats = {
        ph: catPH(vals.ph),
        ec: catEC(vals.ec),
        om: catOM(vals.om),
        n: catN(vals.n),
        p: catP(vals.p),
        k: catK(vals.k),
        s: catS(vals.s),
        cec: catCEC(vals.cec),
        fe: catFe(vals.fe),
        zn: catZn(vals.zn),
        mn: catMn(vals.mn),
        cu: catCu(vals.cu),
        b: catB(vals.b),
      };
      const filtered = Object.entries(cats).filter(([k, v]) => v != null);
      if (!filtered.length) {
        const canvas = el('nutrientChart');
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        return;
      }
      const labels = filtered.map(([k]) => k.toUpperCase());
      const scores = filtered.map(([k, v]) => {
        if (v.lvl === levels.ok) return 100;
        if (v.lvl === levels.mid) return 75;
        if (v.lvl === levels.warn) return 50;
        if (v.lvl === levels.bad) return 25;
      });
      const colors = filtered.map(([k, v]) => getComputedStyle(document.documentElement).getPropertyValue(`--${v.lvl.cls}`));
      const canvas = el('nutrientChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.parentElement.clientWidth;
      canvas.height = 300;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const num = filtered.length;
      const barW = canvas.width / num - 10;
      const gap = 10;
      filtered.forEach((_, i) => {
        const x = i * (barW + gap) + gap / 2;
        const bh = (scores[i] / 100) * (canvas.height - 40);
        ctx.fillStyle = colors[i];
        ctx.fillRect(x, canvas.height - bh - 20, barW, bh);
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text');
        ctx.font = '12px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText(labels[i], x + barW / 2, canvas.height - 5);
        ctx.fillText(scores[i] + '%', x + barW / 2, canvas.height - bh - 25);
      });
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
      ctx.beginPath();
      ctx.moveTo(0, canvas.height - 20);
      ctx.lineTo(canvas.width, canvas.height - 20);
      ctx.stroke();
    }

    // ---- Persistencia (guardar/cargar) ----
    const LS_DATA = 'soilapp.data';
    function setSaveStatus(msg, ok=true){ const s=el('saveStatus'); if(!s) return; s.textContent=msg; s.className = 'status '+(ok?'ok':'err'); }
    function setPdfStatus(msg, ok=true){ const s=el('pdfStatus'); if(!s) return; s.textContent=msg; s.className = 'status '+(ok?'ok':'err'); }

    function saveForm(){
      const data = collectFormData();
      try{
        localStorage.setItem(LS_DATA, JSON.stringify(data));
        setSaveStatus('Datos guardados localmente. üíæ');
      }catch(e){
        setSaveStatus('No se pudo guardar en este navegador.', false);
      }
    }
    function loadForm(){
      try{
        const raw = localStorage.getItem(LS_DATA);
        if(!raw){ setSaveStatus('No hay datos guardados a√∫n.', false); return; }
        const data = JSON.parse(raw);
        Object.entries(data).forEach(([k,v])=>{ if(el(k)) el(k).value = v; });
        setSaveStatus('Datos cargados. ‚úÖ');
        buildInterpretation();
      }catch(e){
        setSaveStatus('Error al cargar.', false);
      }
    }

    function makePrintableHTML(){
      const when = new Date().toLocaleString();
      const data = collectFormData();
      // Asegura que los resultados est√©n actualizados en el reporte
      const { text } = buildInterpretation();
      const rows = Object.entries(data).map(([k,v])=>`<tr><td>${k}</td><td>${(v||'').toString().replace(/</g,'&lt;')}</td></tr>`).join('');
      const resHTML = el('results')?.innerHTML || '';
      const aiHTML = (el('aiOut')?.innerHTML || '').trim();
      const aiSection = aiHTML ? `<div class="section">\n          <h2>IA ‚Äì An√°lisis y recomendaciones</h2>\n          ${aiHTML}\n        </div>` : '';
      return `<!doctype html><html><head><meta charset="utf-8"><title>Reporte an√°lisis de suelos</title>
        <style>
          body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#0b1320;margin:24px}
          h1{font-size:20px;margin:0 0 8px}
          .meta{color:#374151;font-size:12px;margin-bottom:14px}
          table{border-collapse:collapse;width:100%;font-size:12px;margin:12px 0}
          td,th{border:1px solid #c7ced9;padding:6px 8px}
          .section{margin:14px 0}
          .note{font-size:12px;color:#374151}
          ul{margin:8px 0 8px 18px}
          .msg{font-size:14px;color:#111827}
          @media print{.no-print{display:none}}
        </style>
      </head><body>
        <h1>Interpretador de An√°lisis de Suelos ‚Äî Reporte</h1>
        <div class="meta">Generado: ${when}</div>
        <div class="section">
          <h2>Datos ingresados</h2>
          <table><thead><tr><th>Par√°metro</th><th>Valor</th></tr></thead><tbody>${rows}</tbody></table>
        </div>
        <div class="section">
          <h2>Resultados e interpretaci√≥n</h2>
          ${resHTML}
        </div>
        ${aiSection}
        <p class="note">Uso educativo. Ajustar seg√∫n cultivo/m√©todo anal√≠tico/localidad.</p>
      </body></html>`;
    }

    function exportPDF(){
      setPdfStatus('Preparando documento‚Ä¶');
      try{
        const html = makePrintableHTML();
        let win = null;
        try { win = window.open('', '_blank', 'noopener,noreferrer'); } catch(_) {}
        if(!win){
          setPdfStatus('El navegador bloque√≥ la ventana de impresi√≥n. Descargando HTML‚Ä¶', false);
          downloadHTMLFile(html, 'reporte-analisis-suelos.html');
          return;
        }
        win.document.open();
        win.document.write(html);
        win.document.close();
        try { win.focus(); } catch(_) {}
        setTimeout(()=>{
          try { win.print(); setPdfStatus('Abierto di√°logo de impresi√≥n. üñ®Ô∏è'); }
          catch(e){ setPdfStatus('No se pudo abrir la impresi√≥n autom√°tica. Usa Ctrl/Cmd+P en la nueva pesta√±a.', false); }
        }, 250);
      }catch(e){
        setPdfStatus('Error preparando el PDF. Descargando HTML‚Ä¶', false);
        try{ const html = makePrintableHTML(); downloadHTMLFile(html, 'reporte-analisis-suelos.html'); }catch(_){}
      }
    }

    function downloadHTMLFile(html, filename){
      try{
        const blob = new Blob([html], {type:'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename || 'documento.html';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 500);
      }catch(e){ setPdfStatus('No fue posible descargar el archivo HTML.', false); }
    }

    // --- Filtro de resultados ---
    function applyFilter(mode){
      const nodes = document.querySelectorAll('.result[data-kind="param"]');
      nodes.forEach(r=>{
        const lvl = r.getAttribute('data-level') || '';
        if(mode==='all'){
          r.style.display = '';
        }else if(mode==='issues'){
          r.style.display = (lvl==='bad' || lvl==='warn') ? '' : 'none';
        }
      });
    }

    // --- Botones principales ---
    el('btnRun')?.addEventListener('click', (e)=>{ 
      e.preventDefault(); 
      buildInterpretation(); 
    });

    el('btnDemo')?.addEventListener('click', ()=>{ 
      const demo = {ph:5.6, ec:3.8, om:1.8, n:18, p:12, k:70, s:6, cec:8, texture:'Franca', ca:6, mg:2, na:0.6, fe:5.5, zn:0.45, mn:9, cu:0.25, b:0.9, crop:'Ma√≠z'}; 
      Object.entries(demo).forEach(([k,v])=>{ if(el(k)) el(k).value = v; }); 
      buildInterpretation(); 
    });

    function clearForm(preserveKey=true){
      const keep = preserveKey ? (el('apiKey')?.value||'') : '';
      document.querySelectorAll('input, textarea, select').forEach(x=>{
        if(preserveKey && x.id==='apiKey') return;
        if(x.type==='checkbox') x.checked=false; else x.value='';
      });
      if(preserveKey && el('apiKey')) el('apiKey').value = keep;
      el('results').innerHTML = '<p class="note">Ingresa datos y presiona <strong>Interpretar</strong>.</p>';
      el('aiOut').style.display='none';
      el('aiOut').innerHTML='';
      setSaveStatus('');
      setPdfStatus('');
      el('apiKey')?.classList.remove('is-ok','is-err');
      el('aiQ')?.classList.remove('is-ok','is-err');
      drawNutrientChart({});
    }
    el('btnClear')?.addEventListener('click', ()=> clearForm(true));
    el('btnSave')?.addEventListener('click', saveForm);
    el('btnLoad')?.addEventListener('click', loadForm);
    el('btnPrint')?.addEventListener('click', exportPDF);

    el('fltAll')?.addEventListener('click', ()=> applyFilter('all'));
    el('fltIssues')?.addEventListener('click', ()=> applyFilter('issues'));

    // --- IA Gemini (con fallback v1/v1beta y ajuste de colores de campo) ---
    const LS_KEY = 'soilapp.geminiKey';
    let MODELS_CACHE = [];

    function markFieldOK(id){ const x = el(id); if(!x) return; x.classList.remove('is-err'); x.classList.add('is-ok'); }
    function markFieldERR(id){ const x = el(id); if(!x) return; x.classList.remove('is-ok'); x.classList.add('is-err'); }

    function getKey(){ const direct = el('apiKey') ? (el('apiKey').value||'').trim() : ''; return direct || localStorage.getItem(LS_KEY) || ''; }
    function setKeyStatus(msg, ok=true){ const ks = el('keyStatus'); if(!ks) return; ks.textContent = msg; ks.style.color = ok ? 'var(--ok)' : 'var(--bad)'; }
    function loadSavedKey(){ const k = localStorage.getItem(LS_KEY); if(k && el('apiKey')){ el('apiKey').value = k; setKeyStatus('API Key cargada de este navegador. üîë'); } }
    function sanitizeModelName(name){ return (name||'').replace(/^models\//,''); }

    async function fetchModels(key){
      for(const v of ['v1','v1beta']){
        const url = `https://generativelanguage.googleapis.com/${v}/models?key=${encodeURIComponent(key)}`;
        const res = await fetch(url, {headers:{'x-goog-api-key': key}});
        if(res.ok){ return await res.json(); }
        if(res.status === 404) continue; // probar siguiente versi√≥n
        const t = await res.text(); throw new Error(`${res.status} ${t}`);
      }
      throw new Error('404 Lista de modelos no disponible en v1 ni v1beta');
    }

    function setModelsInSelect(list){
      MODELS_CACHE = Array.isArray(list)? list : [];
      const sel = el('modelSel'); if(!sel) return;
      const wantedOrder = ['gemini-1.5-flash-latest','gemini-1.5-flash','gemini-1.5-pro-latest','gemini-1.5-pro','gemini-1.5-flash-8b'];
      const names = MODELS_CACHE.map(m=> sanitizeModelName(m.name));
      const unique = [...new Set(names)];
      sel.innerHTML = '';
      unique.sort((a,b)=> (wantedOrder.indexOf(a)+1||999) - (wantedOrder.indexOf(b)+1||999)).forEach(n=>{
        const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt);
      });
      const preferred = wantedOrder.find(x=> unique.includes(x)) || unique[0];
      if(preferred) sel.value = preferred;
      if(unique.length){ markFieldOK('modelSel'); }
    }

    function buildGenUrl(version, model, key){
      const m = sanitizeModelName(model);
      return `https://generativelanguage.googleapis.com/${version}/models/${encodeURIComponent(m)}:generateContent?key=${encodeURIComponent(key)}`;
    }

    async function postGenerate(version, model, key, body){
      const url = buildGenUrl(version, model, key);
      return fetch(url, { method:'POST', headers:{'Content-Type':'application/json','x-goog-api-key': key}, body: JSON.stringify(body)});
    }

    async function generateWithFallback(model, key, body){
      let lastText = '';
      const tryVersions = ['v1','v1beta'];
      const tryModels = (()=>{
        const names = MODELS_CACHE.map(m=> sanitizeModelName(m.name));
        const alt = ['gemini-1.5-flash-latest','gemini-1.5-flash','gemini-1.5-pro-latest','gemini-1.5-pro','gemini-1.5-flash-8b'];
        const pref = [sanitizeModelName(model), ...alt].filter(Boolean);
        const fromCache = pref.filter(n=> !names.length || names.includes(n));
        return [...new Set(fromCache)].slice(0,3); // m√°ximo 3 intentos distintos de modelo
      })();

      for(const m of tryModels){
        for(const v of tryVersions){
          const res = await postGenerate(v, m, key, body);
          if(res.ok){ return await res.json(); }
          const t = await res.text(); lastText = `${res.status} ${t}`;
          if(res.status === 404){ continue; } else { throw new Error(lastText); }
        }
      }
      throw new Error(lastText || '404 No encontrado en v1 ni v1beta');
    }

    loadSavedKey();

    el('btnSaveKey')?.addEventListener('click', ()=>{
      const k = (el('apiKey')?.value||'').trim();
      if(!k){ markFieldERR('apiKey'); alert('Ingresa una API Key antes de guardar.'); return; }
      localStorage.setItem(LS_KEY, k);
      setKeyStatus('API Key guardada localmente. üíæ');
      markFieldOK('apiKey');
    });

    el('btnTestKey')?.addEventListener('click', async()=>{
      const k = getKey();
      if(!k){ markFieldERR('apiKey'); alert('Ingresa o guarda tu API Key primero.'); return; }
      setKeyStatus('Probando API Key‚Ä¶');
      try{
        const data = await fetchModels(k);
        const models = Array.isArray(data.models)? data.models : [];
        setModelsInSelect(models);
        setKeyStatus(`Key v√°lida ‚úì (modelos: ${models.length})`, true);
        markFieldOK('apiKey');
      }catch(e){ setKeyStatus(`Key inv√°lida ‚úó ${e.message}`, false); markFieldERR('apiKey'); }
    });

    el('btnAskAI')?.addEventListener('click', async ()=>{
      const key = getKey();
      const qEl = el('aiQ');
      const q = (qEl?.value||'').trim();
      const modelSel = el('modelSel');
      const model = sanitizeModelName(modelSel?.value || 'gemini-1.5-flash-latest');
      if(!key){ markFieldERR('apiKey'); alert('Pega tu API Key de aistudio.google.com'); return; }
      markFieldOK('apiKey');
      if(!q){ markFieldERR('aiQ'); alert('Escribe tu pregunta para la IA'); return; }
      markFieldOK('aiQ');

      // Si no hay modelos en cach√©, intenta obtenerlos para evitar 404 por modelo no disponible
      if(!MODELS_CACHE.length){
        try { const data = await fetchModels(key); setModelsInSelect(Array.isArray(data.models)? data.models : []);} catch(_){ /* contin√∫a sin frenar */ }
      }

      const ctxOn = !!el('ctx')?.checked;
      const eduOn = !!el('edu')?.checked;
      let prompt;

      if (ctxOn) {
        const { vals } = buildInterpretation();
        const ctx = Object.entries(vals)
          .filter(([k, v]) => v !== null && v !== '' && k !== 'texture' && k !== 'crop')
          .map(([k, v]) => `${k.toUpperCase()}: ${v}`).join(', ');

        prompt = `
Act√∫a como agr√≥nomo especializado en fertilidad de suelos üå±.

Con estos resultados de suelo (${ctx}) y el cultivo "${vals.crop || 'no especificado'}":

${q}

Responde SIEMPRE en espa√±ol, con tono claro y pr√°ctico.
Usa vi√±etas con emojis agr√≠colas (por ejemplo üå±, üåæ, ‚ö†Ô∏è, üíß, üìå, ‚úÖ) para organizar las recomendaciones.
Incluye advertencias de seguridad, supuestos y, si aplica, recomendaciones de manejo de suelo y fertilizaci√≥n.
        `.trim();
      } else {
        // Sin contexto de resultados, pero igual con emojis
        prompt = `
Responde en espa√±ol, de forma clara y pr√°ctica.
Usa vi√±etas con emojis agr√≠colas (üå±, üåæ, ‚ö†Ô∏è, üíß, üìå, ‚úÖ) para organizar las ideas.
Pregunta del usuario: ${q}
        `.trim();
      }

      if(eduOn){
        prompt += '\nExplica tambi√©n el por qu√© de cada recomendaci√≥n, como si fuera una clase para estudiantes de agronom√≠a, con ejemplos concretos y advertencias de manejo seguro.';
      }

      const body = { contents: [{ role:'user', parts: [{ text: prompt }]}] };
      const out = el('aiOut');
      out.style.display='block';
      out.innerHTML = '<div class="msg">Consultando IA‚Ä¶ ü§ñ</div>';

      try{
        const data = await generateWithFallback(model, key, body);
        const parts = (data?.candidates?.[0]?.content?.parts)||[];
        const txt = parts.map(p=>p.text).filter(Boolean).join('\n') || 'Sin respuesta.';
        out.innerHTML = `<h3>Respuesta de IA üåæ</h3><div class="msg">${mdToHtml(escapeHtml(txt))}</div>`;
      } catch(err){
        markFieldERR('apiKey');
        markFieldERR('modelSel');
        out.innerHTML = `<div class="msg" style="color:#fca5a5">Error al consultar IA: ${escapeHtml(err.message)}.<br>Consejos: usa <span class="kbd">Probar API Key</span> para refrescar modelos; cambia a un modelo disponible (lista desplegable) y reintenta.</div>`;
      }
    });

    // Markdown m√≠nimo ‚Üí HTML (negritas, listas, saltos) con emojis y cambio de '*'
    function mdToHtml(s){
      return s
        // Vi√±etas que empiecen con *, - o + ‚Üí lista con emoji üå±
        .replace(/^\s*[\*\-\+]\s+(.*)$/gm, '<li>üå± $1</li>')
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        // P√°rrafos dobles
        .replace(/\n{2,}/g,'</p><p>')
        // Saltos de l√≠nea simples
        .replace(/\n/g,'<br>')
        // Agrupar elementos <li> en una lista <ul>
        .replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>');
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    function toggleKeyVisibility(){
      const f = el('apiKey'); const b = el('btnToggleKey');
      if(!f||!b) return;
      if(f.type==='password'){ f.type='text'; b.textContent='Ocultar'; b.setAttribute('aria-pressed','true'); }
      else { f.type='password'; b.textContent='Mostrar'; b.setAttribute('aria-pressed','false'); }
    }
    el('btnToggleKey')?.addEventListener('click', toggleKeyVisibility);

    // --- PRUEBAS ---
    function log(msg, ok=true){ const logEl = el('testLog'); if(!logEl) return; const line = ok ? `‚úÖ ${msg}` : `‚ùå ${msg}`; logEl.textContent += (logEl.textContent ? '\n' : '') + line; }
    function clearLog(){ const logEl = el('testLog'); if(logEl) logEl.textContent=''; }

    function runSelfTests(){
      clearLog();
      const ids = ['ph','ec','om','n','p','k','s','cec','texture','ca','mg','na','fe','zn','mn','cu','b','crop','results','aiOut','apiKey','btnToggleKey','btnAskAI','btnSaveKey','btnTestKey','modelSel','btnSave','btnLoad','btnPrint'];
      let pass = 0, fail = 0;
      ids.forEach(id=>{ const ok = !!el(id); ok ? pass++ : fail++; log(`Elemento #${id} ${ok?'presente':'faltante'}`, ok); });
      // Test interpretaci√≥n
      try{ 
        const demo = {ph:5.6, ec:3.8, om:1.8, n:18, p:12, k:70, s:6, cec:8, ca:6, mg:2, fe:5.5, zn:0.45, mn:9, cu:0.25, b:0.9}; 
        Object.entries(demo).forEach(([k,v])=>{ if(el(k)) el(k).value = v; }); 
        buildInterpretation(); 
        const txt = el('results')?.innerText || ''; 
        const checks = ['pH','Conductividad el√©ctrica','Materia org√°nica','F√≥sforo','Potasio','CEC','Zinc']; 
        const okAll = checks.every(c=> txt.includes(c)); 
        log('Interpretaci√≥n genera bloques esperados', okAll); 
        okAll ? pass++ : fail++; 
      }catch(e){ log('Interpretaci√≥n lanz√≥ error: '+e.message, false); fail++; }
      // Test guardar/cargar (localStorage)
      try{ 
        const sample = {ph:'6.2',p:'25',crop:'Caf√©'}; 
        Object.entries(sample).forEach(([k,v])=>{ if(el(k)) el(k).value=v; }); 
        saveForm(); 
        const raw = localStorage.getItem(LS_DATA); 
        const okSave = !!raw; 
        log('Guardado en localStorage', okSave); 
        okSave ? pass++ : fail++; 
        document.querySelectorAll('input, textarea, select').forEach(x=>{ if(x.type==='checkbox') x.checked=false; else x.value=''; }); 
        loadForm(); 
        const okLoad = (el('ph')?.value==='6.2' && el('p')?.value==='25' && el('crop')?.value==='Caf√©'); 
        log('Carga desde localStorage', okLoad); 
        okLoad ? pass++ : fail++; 
      }catch(e){ log('Guardar/Cargar fall√≥: '+e.message, false); fail++; }
      // Test preserva API Key al limpiar
      try{ if(el('apiKey')){ el('apiKey').value='KEY123'; clearForm(true); const okKeep = el('apiKey').value==='KEY123'; log('Limpiar preserva API Key', okKeep); okKeep?pass++:fail++; }}catch(e){ log('Prueba clear preserva key fall√≥: '+e.message, false); fail++; }
      // Test toggle mostrar/ocultar API Key
      try{ 
        const f=el('apiKey'), b=el('btnToggleKey'); 
        if(f&&b){ 
          const t0=f.type; 
          toggleKeyVisibility(); 
          const t1=f.type; 
          toggleKeyVisibility(); 
          const okT = (t0==='password' && t1==='text' && f.type==='password'); 
          log('Toggle mostrar/ocultar API Key', okT); 
          okT?pass++:fail++; 
        }
      }catch(e){ log('Toggle key fall√≥: '+e.message, false); fail++; }
      // Test generador de HTML imprimible
      try{ 
        const html = makePrintableHTML(); 
        const okHtml = typeof html === 'string' && html.includes('<table') && html.length > 200; 
        log('Generador de HTML imprimible', okHtml); 
        okHtml ? pass++ : fail++; 
      }catch(e){ log('Generador HTML fall√≥: '+e.message, false); fail++; }
      // Test HTML imprimible es parseable (sin errores de sintaxis)
      try{ 
        const html = makePrintableHTML(); 
        const doc = new DOMParser().parseFromString(html, 'text/html'); 
        const noErr = !doc.querySelector('parsererror'); 
        log('HTML imprimible parsea sin errores', noErr); 
        noErr ? pass++ : fail++; 
      }catch(e){ log('Parser de HTML arroj√≥ error: '+e.message, false); fail++; }
      // Test inclusi√≥n de IA en impresi√≥n
      try{ 
        const aiDemo = '<h3>Respuesta de IA</h3><div class="msg">Recomendaci√≥n demo</div>'; 
        const aiOut = el('aiOut'); 
        if(aiOut){ aiOut.style.display='block'; aiOut.innerHTML = aiDemo; } 
        const html2 = makePrintableHTML(); 
        const okAI = html2.includes('Recomendaci√≥n demo'); 
        log('Impresi√≥n incluye recomendaciones IA si existen', okAI); 
        okAI ? pass++ : fail++; 
      }catch(e){ log('Inclusi√≥n IA en reporte fall√≥: '+e.message, false); fail++; }

      const status = el('testStatus'); 
      if(status){ status.textContent = `Pruebas: ${pass} ok / ${fail} fallas`; status.className = fail? 't-fail' : 't-pass'; }
    }

    el('btnRunTests')?.addEventListener('click', runSelfTests);
    // Ejecuta una vez al cargar
    runSelfTests();

    // (Se quit√≥ la l√≥gica de ‚Äúgr√°ficos en tiempo real‚Äù sobre input/change
    // para que el c√°lculo ocurra solo cuando se presiona Interpretar.)
  </script>
</body>
</html>
